<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Seating Chart Â· SAS</title>
<style>
  :root{
    --brand-bg:#0A2342; --brand-ink:#F8FAFC; --brand-sub:#C9D6E8;
    --accent:#C8102E; --ok:#1FBF75; --line:#1d3c6a;
    --seat-w:110px; --seat-h:70px; --gap:8px; --zoom:1;
  }
  html,body{height:100%} body{
    margin:0; background:var(--brand-bg); color:var(--brand-ink);
    font-family:ui-sans-serif,-apple-system,Segoe UI,Inter,Roboto,Arial;
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(255,255,255,.06), transparent 60%),
      radial-gradient(1200px 600px at 110% 10%, rgba(255,255,255,.05), transparent 60%),
      var(--brand-bg);
  }
  .wrap{max-width:1200px;margin:0 auto;padding:16px 12px 28px}
  .bar{position:sticky;top:0;z-index:5;background:rgba(10,35,66,.9);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.08);padding:10px 12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .title{font-weight:800;font-size:16px;margin-right:auto}.accent{color:var(--accent)}
  button{border:1px solid var(--line);background:#081b36;color:var(--brand-ink);padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer}
  button.p{background:linear-gradient(120deg,var(--accent),#ff4b5f);border-color:transparent}
  button.ok{background:linear-gradient(120deg,var(--ok),#169f5f);border-color:transparent}
  .grid{display:grid;gap:12px;margin-top:12px;grid-template-columns:1fr 1.2fr}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
  label{font-size:12px;color:var(--brand-sub);display:block;margin:8px 0 6px}
  textarea,input,select{width:100%;background:#081b36;color:var(--brand-ink);border:1px solid var(--line);border-radius:12px;padding:12px 14px;box-sizing:border-box}
  textarea{min-height:120px;resize:vertical}
  .note{font-size:12px;color:var(--brand-sub)}
  .okmsg{color:#dcfce7;background:rgba(31,191,117,.12);border:1px solid rgba(31,191,117,.35);padding:8px 10px;border-radius:10px;margin-top:8px}
  .errmsg{color:#fecaca;background:rgba(200,16,46,.12);border:1px solid rgba(200,16,46,.35);padding:8px 10px;border-radius:10px;margin-top:8px}
  .boardOuter{overflow:auto;padding:6px;transform:scale(var(--zoom));transform-origin:top left}
  .board{display:grid;gap:var(--gap);padding:8px;background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.1);border-radius:14px}
  .seat{min-width:var(--seat-w);min-height:var(--seat-h);background:#081b36;border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;flex-direction:column;justify-content:space-between;user-select:none}
  .seat .name{font-weight:800;font-size:15px;line-height:1.2}
  .seat .meta{display:flex;justify-content:space-between;color:var(--brand-sub);font-size:11px}
  .seat.locked{outline:2px dashed #f59e0b}
  .seat[draggable=true]{cursor:grab}.seat.dragging{opacity:.4}.seat.drop{outline:2px solid var(--accent)}
  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:10px 6px 0}
  .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid rgba(255,255,255,.2);border-radius:999px;padding:6px 10px;font-size:12px}
  .sw{width:14px;height:14px;border-radius:3px;border:1px solid rgba(255,255,255,.25)}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#0e2a51;border:1px solid rgba(255,255,255,.15);border-radius:14px;max-width:680px;width:92%;padding:14px}
  .flex{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
  <div class="bar">
    <div class="row">
      <div class="title"><span class="accent">SAS</span> Â· Seating Chart</div>
      <button id="randomBtn" class="p">ðŸŽ² Randomize</button>
      <button id="rulesBtn">Rules</button>
      <button id="exportBtn" class="ok">Export CSV</button>
      <button id="printBtn">Print</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <label>Roster (one per line or comma-separated)</label>
        <textarea id="names" placeholder="Ana
Ben, Carlos
Dina"></textarea>

        <div class="row">
          <div><label>Rows</label><input id="rows" type="number" min="1" value="5" inputmode="numeric"></div>
          <div><label>Columns</label><input id="cols" type="number" min="1" value="6" inputmode="numeric"></div>
          <div><label>Group size</label><input id="gsize" type="number" min="1" value="2" inputmode="numeric"></div>
        </div>

        <div class="row">
          <div>
            <label>Layout mode</label>
            <select id="layout">
              <option value="rowfill">Fill leftâ†’right by rows</option>
              <option value="colfill">Fill topâ†’bottom by columns</option>
            </select>
          </div>
          <div>
            <label>Seat coloring</label>
            <select id="coloring">
              <option value="solo">Solo seats</option>
              <option value="groups">Color by groups</option>
            </select>
          </div>
          <div>
            <label>Random seed (optional)</label>
            <input id="seed" placeholder="e.g. 42" inputmode="numeric">
          </div>
        </div>

        <div class="row">
          <div class="card" style="flex:1">
            <label>Zoom</label><input id="zoom" type="range" min="70" max="180" step="5" value="100">
          </div>
          <div class="card" style="flex:1">
            <label>Seat size</label><input id="seat" type="range" min="70" max="160" step="5" value="100">
          </div>
          <div class="card" style="flex:1">
            <label>Gap</label><input id="gap" type="range" min="0" max="24" step="1" value="8">
          </div>
        </div>

        <div id="msg"></div>
      </div>

      <div class="card">
        <div class="boardOuter" id="boardOuter">
          <div class="board" id="board" aria-live="polite"></div>
        </div>
        <div class="legend" id="legend"></div>
      </div>
    </div>
  </div>

  <!-- Rules Modal -->
  <div class="modal" id="rulesModal" role="dialog" aria-modal="true">
    <div class="box">
      <h3 style="margin:8px 0 6px">Class Rules</h3>
      <div class="note" style="margin-bottom:10px">Would you like to set rules for the randomizer? (You can edit anytime.)</div>
      <div class="flex">
        <div class="card" style="flex:1">
          <b>Keep apart</b>
          <div class="note">One pair per line, comma between names. We avoid side-by-side seats in the same row. (Optionally toggle vertical below.)</div>
          <textarea id="apartTxt" placeholder="Ana,Ben
Carlos,Dina"></textarea>
        </div>
        <div class="card" style="flex:1">
          <b>Keep together (same group)</b>
          <div class="note">One pair per line, comma between names. They will end up in the <u>same group</u> (based on group size).</div>
          <textarea id="togetherTxt" placeholder="Eli,Gabe
Hana,Ivan"></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <label class="note"><input type="checkbox" id="verticalAdj"> Also treat up/down as adjacent (for keep-apart)</label>
        <span style="flex:1"></span>
        <button id="rulesSave" class="ok">Save rules</button>
        <button id="rulesClose">Close</button>
      </div>
    </div>
  </div>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s);
const board=$("#board"), legend=$("#legend"), msg=$("#msg"), modal=$("#rulesModal");
const idx=(r,c,cols)=>r*cols+c;
const toRGBA=(hex,a)=>{try{const h=hex.replace("#",""),x=parseInt(h,16),r=x>>16&255,g=x>>8&255,b=x&255;return `rgba(${r},${g},${b},${a})`}catch(e){return"rgba(255,255,255,.15)"}}
function parseRoster(t){return Array.from(new Set(t.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean)))}
function parsePairs(t){const p=[];t.split(/\n+/).map(s=>s.trim()).filter(Boolean).forEach(line=>{const[a,b]=line.split(",").map(x=>x?.trim()).filter(Boolean);if(a&&b)p.push([a,b])});return p}
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function seededShuffle(arr,seed){const rnd=(seed!==""&&!Number.isNaN(+seed))?mulberry32(+seed):Math.random;const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(rnd()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

/* ===== State ===== */
const S={
  rows:+$("#rows").value, cols:+$("#cols").value, gsize:+$("#gsize").value,
  layout:$("#layout").value, color:$("#coloring").value, seed:$("#seed").value,
  names:[], placed:[], locked:{}, groups:{}, colors:[],
  rules:{apart:[], together:[], vertical:false},
  zoom:1, seatScale:1, gap:8
};

/* ===== Persist ===== */
function save(){localStorage.setItem("seatingRulesV1",JSON.stringify(S))}
function load(){try{
  const s=JSON.parse(localStorage.getItem("seatingRulesV1")||"{}");
  Object.assign(S,s);
  $("#rows").value=S.rows; $("#cols").value=S.cols; $("#gsize").value=S.gsize;
  $("#layout").value=S.layout; $("#coloring").value=S.color; $("#seed").value=S.seed||"";
  $("#names").value=(S.names||[]).join("\n");
  $("#zoom").value=Math.round((S.zoom||1)*100); document.documentElement.style.setProperty('--zoom', String(S.zoom||1));
  $("#seat").value=Math.round((S.seatScale||1)*100); document.documentElement.style.setProperty('--seat-w', `${110*(S.seatScale||1)}px`); document.documentElement.style.setProperty('--seat-h', `${70*(S.seatScale||1)}px`);
  $("#gap").value=S.gap||8; document.documentElement.style.setProperty('--gap', `${S.gap||8}px`);
} catch(e){}}

/* ===== Colors / groups ===== */
function palette(n){const base=["#C8102E","#1FBF75","#F59E0B","#60A5FA","#A78BFA","#F472B6","#06B6D4","#84CC16","#FB7185","#F97316"];return Array.from({length:n},(_,i)=>base[i%base.length])}
function chunk(arr,size){const out=[];for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));return out}
function mapGroups(gs){const m={};gs.forEach((g,i)=>g.forEach(n=>m[n]=i));return m}

/* ===== Constraints ===== */
function adjacency(rows,cols,vertical=false){const a={};for(let r=0;r<rows;r++){for(let c=0;c<cols;c++){const i=idx(r,c,cols),n=[];if(c>0)n.push(idx(r,c-1,cols));if(c<cols-1)n.push(idx(r,c+1,cols));if(vertical){if(r>0)n.push(idx(r-1,c,cols));if(r<rows-1)n.push(idx(r+1,c,cols));}a[i]=n}}return a}
function violatesApart(placed,pairs,adj){if(!pairs?.length)return false;const pos={};placed.forEach((n,i)=>{if(n)pos[n]=i});for(const[a,b] of pairs){const ia=pos[a],ib=pos[b];if(ia==null||ib==null)continue;if(adj[ia]?.includes(ib))return true}return false}
function violatesTogether(placed,pairs,groups){if(!pairs?.length)return false;const pos={};placed.forEach((n,i)=>{if(n)pos[n]=i});for(const[a,b] of pairs){const ga=groups[a],gb=groups[b];if(a in pos && b in pos && (ga==null||gb==null || ga!==gb)) return true}return false}

/* ===== Placement ===== */
function place(shuffled){
  const total=S.rows*S.cols, out=Array(total).fill("");
  for(const k of Object.keys(S.locked)){const i=+k;if(i>=0&&i<total) out[i]=S.locked[k]}
  const lockedNames=new Set(Object.values(S.locked));
  const toPlace=shuffled.filter(n=>!lockedNames.has(n)).slice(0,total);
  let spots=[...Array(total).keys()].filter(i=>!out[i]);
  if(S.layout==="colfill"){spots=[];for(let c=0;c<S.cols;c++){for(let r=0;r<S.rows;r++){const i=idx(r,c,S.cols);if(!out[i])spots.push(i)}}}
  toPlace.forEach((n,i)=>{if(spots[i]!=null) out[spots[i]]=n});
  return out;
}

/* ===== Draw ===== */
function draw(){
  const total=S.rows*S.cols;
  board.style.gridTemplateColumns=`repeat(${S.cols}, minmax(var(--seat-w), 1fr))`;
  board.innerHTML="";
  for(let i=0;i<total;i++){
    const d=document.createElement("div"); d.className="seat"; d.dataset.index=i; d.draggable=true;
    const nm=S.placed[i]||"";
    const name=document.createElement("div"); name.className="name"; name.textContent=nm||"â€”";
    const meta=document.createElement("div"); meta.className="meta"; const left=document.createElement("span"); const right=document.createElement("span");
    if(S.locked[i]){d.classList.add("locked"); left.textContent="ðŸ”’ locked";} right.textContent=`#${i+1}`;
    meta.append(left,right); d.append(name,meta);

    // group color
    if(S.color==="groups"){const gid=S.groups[nm]; if(gid!=null){const clr=S.colors[gid%S.colors.length]; d.style.background=`linear-gradient(135deg, ${toRGBA(clr,.28)}, #081b36 65%)`; d.style.borderColor=clr+"88";}}

    // click = lock/unlock; long-press = reassign; drag = swap
    d.addEventListener("click",()=>toggleLock(i));
    wireLongPress(d,()=>reassignSeat(i));
    wireDrag(d);
    board.appendChild(d);
  }
  renderLegend();
  save();
}
function renderLegend(){
  legend.innerHTML=""; if(S.color!=="groups")return;
  const inv=[]; for(const[n,g] of Object.entries(S.groups)){if(!inv[g])inv[g]=[];inv[g].push(n)}
  inv.filter(Boolean).forEach((members,i)=>{const chip=document.createElement("div");chip.className="chip";
    const sw=document.createElement("span");sw.className="sw";sw.style.background=S.colors[i%S.colors.length];
    const t=document.createElement("span");t.textContent=`Group ${i+1} (${members.length})`; chip.append(sw,t); legend.appendChild(chip);
  });
}

/* ===== Interactions ===== */
function randomize(){
  S.rows=Math.max(1,+$("#rows").value||1); S.cols=Math.max(1,+$("#cols").value||1);
  S.gsize=Math.max(1,+$("#gsize").value||1); S.layout=$("#layout").value; S.color=$("#coloring").value;
  S.seed=$("#seed").value; S.names=parseRoster($("#names").value);
  if(!S.names.length){flash("Please add at least one name.",true);return}
  const tries=2500, adj=adjacency(S.rows,S.cols,S.rules.vertical);
  let best=null;
  for(let t=0;t<tries;t++){
    const sh=seededShuffle(S.names, S.seed? (+S.seed+t):"");
    // create groups off the shuffled order
    const gs=chunk(sh,S.gsize); S.groups=mapGroups(gs); S.colors=palette(gs.length);
    const placed=place(sh);
    if(!violatesApart(placed,S.rules.apart,adj) && !violatesTogether(placed,S.rules.together,S.groups)){best=placed;break}
    if(t===0) best=placed;
  }
  S.placed=best.slice(0,S.rows*S.cols); draw(); flash("Seating updated.",false);
}
function toggleLock(i){const nm=S.placed[i]; if(!nm)return; if(S.locked[i]) delete S.locked[i]; else{for(const[k,v] of Object.entries(S.locked)){if(v===nm) delete S.locked[k]} S.locked[i]=nm} draw()}
function exportCSV(){let out="Row,Col,Seat,Name,Group\n";for(let r=0;r<S.rows;r++){for(let c=0;c<S.cols;c++){const i=idx(r,c,S.cols), n=S.placed[i]||"", g=S.groups[n]!=null?S.groups[n]+1:""; out+=`${r+1},${c+1},${i+1},"${n.replace(/"/g,'""')}",${g}\n`}} const blob=new Blob([out],{type:"text/csv"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="seating-chart.csv"; a.click()}
function printBoard(){window.print()}
function flash(t,err){msg.innerHTML=`<div class="${err?'errmsg':'okmsg'}">${t}</div>`; setTimeout(()=>msg.innerHTML="",2500)}

/* Drag & drop swap */
let dragFrom=null;
function wireDrag(el){
  el.addEventListener("dragstart",e=>{dragFrom=+el.dataset.index; el.classList.add("dragging"); e.dataTransfer.effectAllowed="move"});
  el.addEventListener("dragover",e=>{e.preventDefault(); el.classList.add("drop"); e.dataTransfer.dropEffect="move"});
  el.addEventListener("dragleave",()=>el.classList.remove("drop"));
  el.addEventListener("dragend",()=>{dragFrom=null; el.classList.remove("dragging"); document.querySelectorAll(".seat").forEach(x=>x.classList.remove("drop"))});
  el.addEventListener("drop",e=>{
    e.preventDefault(); const to=+el.dataset.index; if(dragFrom==null||to===dragFrom) return;
    const a=S.placed[dragFrom], b=S.placed[to]; S.placed[dragFrom]=b; S.placed[to]=a;
    // keep locks attached to positions
    const lf=S.locked[dragFrom], lt=S.locked[to]; delete S.locked[dragFrom]; delete S.locked[to];
    if(lf && b===lf) S.locked[to]=b; if(lt && a===lt) S.locked[dragFrom]=a;
    draw();
  });
}

/* Long-press to reassign */
function wireLongPress(el,cb){let t=null; el.addEventListener("touchstart",e=>{t=setTimeout(()=>cb(),450)}, {passive:true}); el.addEventListener("touchend",()=>clearTimeout(t)); el.addEventListener("mousedown",e=>{t=setTimeout(()=>cb(),450)}); el.addEventListener("mouseup",()=>clearTimeout(t))}
function reassignSeat(i){
  // Build a quick picker from roster
  const list=S.names.slice().sort((a,b)=>a.localeCompare(b));
  const curr=S.placed[i]||"";
  const pick=prompt("Assign seat #"+(i+1)+" to:", curr ? `${curr}` : list[0]||"");
  if(!pick) return;
  if(!S.names.includes(pick)){flash("Name not in roster. Add it first.",true);return}
  // remove pick from its current seat
  const j=S.placed.findIndex(n=>n===pick); if(j>=0) S.placed[j]="";
  S.placed[i]=pick; draw();
}

/* ===== Rules modal ===== */
function openRules(){ $("#apartTxt").value=S.rules.apart.map(p=>p.join(",")).join("\n"); $("#togetherTxt").value=S.rules.together.map(p=>p.join(",")).join("\n"); $("#verticalAdj").checked=!!S.rules.vertical; modal.style.display="flex"}
function saveRules(){ S.rules.apart=parsePairs($("#apartTxt").value); S.rules.together=parsePairs($("#togetherTxt").value); S.rules.vertical=$("#verticalAdj").checked; save(); modal.style.display="none"; flash("Rules saved.",false)}

/* ===== Wire UI ===== */
$("#randomBtn").addEventListener("click", randomize);
$("#exportBtn").addEventListener("click", exportCSV);
$("#printBtn").addEventListener("click", printBoard);
$("#rulesBtn").addEventListener("click", openRules);
$("#rulesSave").addEventListener("click", saveRules);
$("#rulesClose").addEventListener("click", ()=>modal.style.display="none");
["rows","cols","gsize","layout","coloring","seed","names"].forEach(id=>{
  const el=$("#"+id); el.addEventListener(el.tagName==="TEXTAREA"?"input":"change", save);
});
$("#zoom").addEventListener("input",e=>{S.zoom=(+e.target.value)/100;document.documentElement.style.setProperty('--zoom',String(S.zoom));save()});
$("#seat").addEventListener("input",e=>{S.seatScale=(+e.target.value)/100;document.documentElement.style.setProperty('--seat-w',`${110*S.seatScale}px`);document.documentElement.style.setProperty('--seat-h',`${70*S.seatScale}px`);save()});
$("#gap").addEventListener("input",e=>{S.gap=+e.target.value;document.documentElement.style.setProperty('--gap',`${S.gap}px`);save()});

/* ===== Init ===== */
load();
if(!(localStorage.getItem("askedRulesOnce")||"")){ modal.style.display="flex"; localStorage.setItem("askedRulesOnce","1") }
if(!S.names?.length){ $("#names").value=`Ana
Ben
Carlos
Dina
Eli
Fatima
Gabe
Hana
Ivan
Jada
Ken
Lia
Mia
Nate
Omar
Pia
Quinn
Rae
Sam
Tia
Uma
Vic
Will
Xena
Yara
Zoe`; }
</script>
</body>
</html>
